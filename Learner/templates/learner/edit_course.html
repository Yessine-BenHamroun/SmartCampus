{% extends 'learner/base.html' %}
{% load static %}

{% block title %}Edit Course - SmartCampus{% endblock %}

{% block body_class %}edit-course-page{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header section light-background">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8" data-aos="fade-up">
        <h1>Edit Course</h1>
        <p>Update your course information and content</p>
      </div>
      <div class="col-lg-4 text-end" data-aos="fade-up" data-aos-delay="100">
        <a href="{% url 'instructor_courses' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to My Courses
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Edit Course Section -->
<section class="edit-course-section section">
  <div class="container">
    <div class="row">
      <!-- Course Form -->
      <div class="col-lg-8">
        <div class="course-form-card" data-aos="fade-up">
          <form method="post" id="editCourseForm">
            {% csrf_token %}
            
            <div class="form-section">
              <h3><i class="bi bi-info-circle"></i> Basic Information</h3>
              
              <div class="mb-4">
                <label for="title" class="form-label">Course Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="title" name="title" required 
                       value="{{ course.title }}" placeholder="e.g., Complete Web Development Bootcamp">
              </div>
              
              <div class="mb-4">
                <label for="description" class="form-label">Course Description <span class="text-danger">*</span></label>
                <textarea class="form-control" id="description" name="description" rows="6" required
                          placeholder="Describe what students will learn...">{{ course.description }}</textarea>
              </div>
              
              <div class="row mb-4">
                <div class="col-md-6">
                  <label for="category" class="form-label">Category</label>
                  <select class="form-select" id="category" name="category">
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if course.category == cat %}selected{% endif %}>{{ cat|title }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="col-md-6">
                  <label for="level" class="form-label">Difficulty Level</label>
                  <select class="form-select" id="level" name="level">
                    {% for lvl in levels %}
                    <option value="{{ lvl }}" {% if course.level == lvl %}selected{% endif %}>{{ lvl|title }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="mb-4">
                <label for="price" class="form-label">Price ($)</label>
                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" 
                       value="{{ course.price|default:0 }}">
              </div>
            </div>
            
            <div class="form-section">
              <h3><i class="bi bi-image"></i> Media</h3>
              
              <div class="mb-4">
                <label for="thumbnail" class="form-label">Course Thumbnail URL</label>
                <input type="url" class="form-control" id="thumbnail" name="thumbnail" 
                       value="{{ course.thumbnail }}" placeholder="https://example.com/thumbnail.jpg">
              </div>
              
              <div class="mb-4">
                <label for="preview_video" class="form-label">Preview Video URL</label>
                <input type="url" class="form-control" id="preview_video" name="preview_video" 
                       value="{{ course.preview_video }}" placeholder="https://youtube.com/watch?v=...">
              </div>
            </div>
            
            <div class="form-section">
              <h3><i class="bi bi-toggles"></i> Publishing</h3>
              
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="published" name="published" 
                       value="true" {% if course.published %}checked{% endif %}>
                <label class="form-check-label" for="published">
                  Publish this course (make it visible to students)
                </label>
              </div>
            </div>
            
            <div class="form-actions">
              <a href="{% url 'instructor_courses' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Course Curriculum -->
      <div class="col-lg-4">
        <div class="curriculum-card" data-aos="fade-up" data-aos-delay="100">
          <h3><i class="bi bi-list-ol"></i> Course Curriculum</h3>
          
          <div class="curriculum-stats mb-4">
            <div class="stat">
              <i class="bi bi-folder"></i>
              <span>{{ course.modules|length|default:0 }} Modules</span>
            </div>
            <div class="stat">
              <i class="bi bi-file-text"></i>
              <span>
                {% for module in course.modules %}{{ module.lessons|length|default:0 }}{% if not forloop.last %}+{% endif %}{% endfor %} Lessons
              </span>
            </div>
          </div>
          
          {% if course.modules %}
            <div class="modules-list">
              {% for module in course.modules %}
              <div class="module-item">
                <div class="module-header">
                  <h5>{{ forloop.counter }}. {{ module.title }}</h5>
                  <div>
                    <span class="badge bg-secondary">{{ module.lessons|length|default:0 }} lessons</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="addLesson('{{ module.id }}', '{{ module.title }}')">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>
                {% if module.lessons %}
                  <ul class="lessons-list">
                    {% for lesson in module.lessons %}
                    <li>
                      <i class="bi bi-{% if lesson.content_type == 'video' %}play-circle{% elif lesson.content_type == 'quiz' %}question-circle{% elif lesson.content_type == 'text' %}file-text{% else %}file-earmark{% endif %}"></i>
                      {{ lesson.title }}
                      <small class="text-muted">({{ lesson.duration_minutes }} min)</small>
                      {% if lesson.resources %}
                        <i class="bi bi-paperclip text-primary ms-1" title="{{ lesson.resources|length }} attachment(s)"></i>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            <button class="btn btn-primary w-100 mt-3" onclick="openAddModuleModal()">
              <i class="bi bi-plus-circle"></i> Add Module
            </button>
          {% else %}
            <div class="empty-curriculum text-center py-4">
              <i class="bi bi-folder-x display-4 text-muted mb-3"></i>
              <p class="text-muted">No curriculum created yet</p>
              <button class="btn btn-sm btn-primary" onclick="openAddModuleModal()">
                <i class="bi bi-plus-circle"></i> Add Module
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Add Module Modal -->
<div class="modal fade" id="addModuleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-folder-plus"></i> Add New Module</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addModuleForm">
          <div class="mb-3">
            <label for="moduleTitle" class="form-label">Module Title *</label>
            <input type="text" class="form-control" id="moduleTitle" required>
          </div>
          <div class="mb-3">
            <label for="moduleDescription" class="form-label">Description</label>
            <textarea class="form-control" id="moduleDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="moduleOrder" class="form-label">Order</label>
            <input type="number" class="form-control" id="moduleOrder" value="{{ course.modules|length|default:0|add:1 }}" min="1">
            <small class="text-muted">Position of this module in the course</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitModule()">
          <i class="bi bi-check-circle"></i> Create Module
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Lesson Modal -->
<div class="modal fade" id="addLessonModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-file-plus"></i> Add New Lesson</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addLessonForm">
          <input type="hidden" id="lessonModuleId">
          <div class="mb-3">
            <label class="form-label">Module</label>
            <input type="text" class="form-control" id="lessonModuleName" disabled>
          </div>
          <div class="mb-3">
            <label for="lessonTitle" class="form-label">Lesson Title *</label>
            <input type="text" class="form-control" id="lessonTitle" required>
          </div>
          <div class="mb-3">
            <label for="lessonDescription" class="form-label">Description</label>
            <textarea class="form-control" id="lessonDescription" rows="2"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="lessonContentType" class="form-label">Content Type *</label>
                <select class="form-select" id="lessonContentType" onchange="updateContentFields()" required>
                  <option value="text">Text/Article</option>
                  <option value="video">Video</option>
                  <option value="quiz">Quiz</option>
                  <option value="exercise">Exercise</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="lessonDuration" class="form-label">Duration (minutes)</label>
                <input type="number" class="form-control" id="lessonDuration" value="0" min="0">
              </div>
            </div>
          </div>
          
          <!-- Content Fields (dynamic based on type) -->
          <div id="contentFields">
            <div id="textContentField">
              <div class="mb-3">
                <label for="lessonTextContent" class="form-label">Text Content *</label>
                <textarea class="form-control" id="lessonTextContent" rows="8" placeholder="Enter your lesson content here..."></textarea>
                <small class="text-muted">Write your lesson content</small>
              </div>
            </div>
            <div id="videoContentField" style="display:none;">
              <div class="mb-3">
                <label for="lessonVideoUrl" class="form-label">Video URL *</label>
                <input type="url" class="form-control" id="lessonVideoUrl" placeholder="https://youtube.com/watch?v=... or https://vimeo.com/...">
                <small class="text-muted">YouTube, Vimeo, or direct video URL</small>
              </div>
            </div>
          </div>
          
          <!-- File Attachments Section -->
          <div class="mb-3">
            <label class="form-label">
              <i class="bi bi-paperclip"></i> Attachments (Optional)
            </label>
            <div class="file-upload-area" id="fileUploadArea">
              <div class="file-upload-placeholder">
                <i class="bi bi-cloud-upload"></i>
                <p>Click to upload files or drag and drop</p>
                <small class="text-muted">PDF, ZIP, Images, Documents (Max 50MB per file)</small>
              </div>
              <input type="file" id="lessonFiles" multiple hidden accept=".pdf,.zip,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
            </div>
            <div id="fileList" class="file-list mt-2"></div>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="lessonFreePreview">
              <label class="form-check-label" for="lessonFreePreview">
                Free Preview (allow non-enrolled students to view)
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitLesson()">
          <i class="bi bi-check-circle"></i> Create Lesson
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.course-form-card, .curriculum-card {
  background: white;
  border-radius: 10px;
  padding: 30px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.curriculum-card {
  position: sticky;
  top: 100px;
}

.curriculum-card h3 {
  color: var(--heading-color);
  font-size: 1.3rem;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.curriculum-stats {
  display: flex;
  gap: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.curriculum-stats .stat {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--default-color);
}

.curriculum-stats .stat i {
  color: var(--accent-color);
  font-size: 1.2rem;
}

.modules-list {
  max-height: 500px;
  overflow-y: auto;
}

.module-item {
  padding: 15px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  margin-bottom: 15px;
}

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.module-header h5 {
  margin: 0;
  font-size: 1rem;
  color: var(--heading-color);
}

.lessons-list {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.lessons-list li {
  padding: 8px 0;
  padding-left: 20px;
  border-left: 2px solid #e9ecef;
  margin-left: 10px;
  font-size: 0.9rem;
  color: var(--default-color);
  display: flex;
  align-items: center;
  gap: 8px;
}

.lessons-list li i {
  color: var(--accent-color);
}

.empty-curriculum {
  background: #f8f9fa;
  border-radius: 8px;
}

.form-section {
  margin-bottom: 30px;
  padding-bottom: 30px;
  border-bottom: 2px solid #e9ecef;
}

.form-section:last-of-type {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.form-section h3 {
  color: var(--heading-color);
  font-size: 1.3rem;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-section h3 i {
  color: var(--accent-color);
}

.form-label {
  font-weight: 600;
  color: var(--heading-color);
  margin-bottom: 8px;
}

.form-control, .form-select {
  border: 2px solid #e9ecef;
  padding: 12px 15px;
  border-radius: 8px;
  transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25);
}

textarea.form-control {
  resize: vertical;
  min-height: 120px;
}

.form-check-input:checked {
  background-color: var(--accent-color);
  border-color: var(--accent-color);
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.25rem rgba(var(--accent-color-rgb), 0.25);
}

.form-actions {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 30px;
  padding-top: 30px;
  border-top: 2px solid #e9ecef;
}

.form-actions .btn {
  padding: 12px 30px;
  font-weight: 600;
}

.file-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: #f8f9fa;
}

.file-upload-area:hover {
  border-color: var(--accent-color);
  background: #fff;
}

.file-upload-area.dragover {
  border-color: var(--accent-color);
  background: #e7f3ff;
}

.file-upload-placeholder i {
  font-size: 3rem;
  color: var(--accent-color);
  margin-bottom: 10px;
}

.file-upload-placeholder p {
  margin: 10px 0 5px;
  font-weight: 600;
  color: var(--heading-color);
}

.file-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.file-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 15px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.file-item-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
}

.file-item-info i {
  font-size: 1.5rem;
  color: var(--accent-color);
}

.file-item-details {
  display: flex;
  flex-direction: column;
}

.file-item-name {
  font-weight: 600;
  color: var(--heading-color);
}

.file-item-size {
  font-size: 0.85rem;
  color: #6c757d;
}

.file-item-remove {
  background: none;
  border: none;
  color: #dc3545;
  cursor: pointer;
  padding: 5px 10px;
  border-radius: 4px;
  transition: all 0.3s;
}

.file-item-remove:hover {
  background: #dc3545;
  color: white;
}
</style>

<script>
const courseId = '{{ course.id }}';
let selectedFiles = [];

// Wait for page to load
window.addEventListener('load', function() {
  const lessonModal = document.getElementById('addLessonModal');
  
  // Clean up when modal closes
  lessonModal.addEventListener('hidden.bs.modal', function () {
    selectedFiles = [];
    document.getElementById('fileList').innerHTML = '';
    
    // Reset form
    document.getElementById('addLessonForm').reset();
    updateContentFields();
  });
});

// File Upload Handling
const fileUploadArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('lessonFiles');
const fileList = document.getElementById('fileList');

fileUploadArea.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', (e) => {
  handleFiles(e.target.files);
});

// Drag and Drop
fileUploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
  fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  fileUploadArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

function handleFiles(files) {
  Array.from(files).forEach(file => {
    // Check file size (50MB limit)
    if (file.size > 50 * 1024 * 1024) {
      alert(`File "${file.name}" is too large. Maximum size is 50MB.`);
      return;
    }
    
    selectedFiles.push(file);
    displayFile(file);
  });
}

function displayFile(file) {
  const fileItem = document.createElement('div');
  fileItem.className = 'file-item';
  fileItem.innerHTML = `
    <div class="file-item-info">
      <i class="bi bi-file-earmark-${getFileIcon(file.name)}"></i>
      <div class="file-item-details">
        <span class="file-item-name">${file.name}</span>
        <span class="file-item-size">${formatFileSize(file.size)}</span>
      </div>
    </div>
    <button type="button" class="file-item-remove" onclick="removeFile('${file.name}')">
      <i class="bi bi-trash"></i>
    </button>
  `;
  fileList.appendChild(fileItem);
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'image';
  if (['pdf'].includes(ext)) return 'pdf';
  if (['doc', 'docx'].includes(ext)) return 'word';
  if (['xls', 'xlsx'].includes(ext)) return 'excel';
  if (['ppt', 'pptx'].includes(ext)) return 'ppt';
  if (['zip', 'rar'].includes(ext)) return 'zip';
  return 'text';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function removeFile(filename) {
  selectedFiles = selectedFiles.filter(f => f.name !== filename);
  const fileItems = fileList.querySelectorAll('.file-item');
  fileItems.forEach(item => {
    if (item.querySelector('.file-item-name').textContent === filename) {
      item.remove();
    }
  });
}

function openAddModuleModal() {
  const modal = new bootstrap.Modal(document.getElementById('addModuleModal'));
  modal.show();
}

function submitModule() {
  const title = document.getElementById('moduleTitle').value;
  const description = document.getElementById('moduleDescription').value;
  const order = document.getElementById('moduleOrder').value;
  
  if (!title) {
    alert('Please enter a module title');
    return;
  }
  
  const data = {
    title: title,
    description: description,
    order: parseInt(order)
  };
  
  fetch(`http://localhost:8001/api/courses/instructor/course/${courseId}/modules/create/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer {{ request.session.access_token }}'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.message) {
      alert('Module created successfully!');
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to create module'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error creating module');
  });
}

function addLesson(moduleId, moduleName) {
  document.getElementById('lessonModuleId').value = moduleId;
  document.getElementById('lessonModuleName').value = moduleName;
  const modal = new bootstrap.Modal(document.getElementById('addLessonModal'));
  modal.show();
}

function updateContentFields() {
  const contentType = document.getElementById('lessonContentType').value;
  
  // Hide all content fields
  document.getElementById('textContentField').style.display = 'none';
  document.getElementById('videoContentField').style.display = 'none';
  
  // Show relevant field
  if (contentType === 'text') {
    document.getElementById('textContentField').style.display = 'block';
  } else if (contentType === 'video') {
    document.getElementById('videoContentField').style.display = 'block';
  }
}

async function submitLesson() {
  const moduleId = document.getElementById('lessonModuleId').value;
  const title = document.getElementById('lessonTitle').value;
  const description = document.getElementById('lessonDescription').value;
  const contentType = document.getElementById('lessonContentType').value;
  const duration = document.getElementById('lessonDuration').value;
  const freePreview = document.getElementById('lessonFreePreview').checked;
  
  if (!title) {
    alert('Please enter a lesson title');
    return;
  }
  
  let content = {};
  if (contentType === 'text') {
    // Get content from textarea
    content.text_content = document.getElementById('lessonTextContent').value;
  } else if (contentType === 'video') {
    content.video_url = document.getElementById('lessonVideoUrl').value;
  }
  
  // If there are files, use FormData
  if (selectedFiles.length > 0) {
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('content_type', contentType);
    formData.append('content', JSON.stringify(content));
    formData.append('duration_minutes', parseInt(duration));
    formData.append('is_free_preview', freePreview);
    formData.append('course_id', courseId);
    
    // Add files
    selectedFiles.forEach((file) => {
      formData.append('files', file);
    });
    
    try {
      const response = await fetch(`http://localhost:8001/api/courses/instructor/module/${moduleId}/lessons/`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer {{ request.session.access_token }}'
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (data.message) {
        alert('Lesson created successfully!');
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'Failed to create lesson'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error creating lesson');
    }
  } else {
    // No files, use JSON
    const payload = {
      title: title,
      description: description,
      content_type: contentType,
      content: content,
      duration_minutes: parseInt(duration),
      is_free_preview: freePreview,
      course_id: courseId
    };
    
    try {
      const response = await fetch(`http://localhost:8001/api/courses/instructor/module/${moduleId}/lessons/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer {{ request.session.access_token }}'
        },
        body: JSON.stringify(payload)
      });
      
      const data = await response.json();
      
      if (data.message) {
        alert('Lesson created successfully!');
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'Failed to create lesson'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error creating lesson');
    }
  }
}
</script>
{% endblock %}
