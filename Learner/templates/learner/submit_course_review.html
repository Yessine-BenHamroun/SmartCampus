{% extends 'learner/base.html' %}
{% load static %}

{% block title %}Review Course - SmartCampus{% endblock %}

{% block content %}
<section class="page-header section light-background">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1>Review Course</h1>
        <p>{{ course.title }}</p>
      </div>
      <a href="{% url 'course_detail' course_id %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Course
      </a>
    </div>
  </div>
</section>

<section class="review-section section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="review-card">
          <div class="course-info-header">
            <img src="{{ course.thumbnail_url }}" alt="{{ course.title }}" class="course-thumbnail">
            <div>
              <h3>{{ course.title }}</h3>
              <p class="text-muted">Share your experience with this course</p>
            </div>
          </div>

          <form id="reviewForm">
            {% csrf_token %}
            
            <!-- Rating -->
            <div class="mb-4">
              <label class="form-label">Overall Rating *</label>
              <div class="star-rating">
                <input type="radio" name="rating" value="5" id="star5">
                <label for="star5" title="5 stars">★</label>
                <input type="radio" name="rating" value="4" id="star4">
                <label for="star4" title="4 stars">★</label>
                <input type="radio" name="rating" value="3" id="star3">
                <label for="star3" title="3 stars">★</label>
                <input type="radio" name="rating" value="2" id="star2">
                <label for="star2" title="2 stars">★</label>
                <input type="radio" name="rating" value="1" id="star1">
                <label for="star1" title="1 star">★</label>
              </div>
              <small class="text-muted">Click on the stars to rate</small>
            </div>

            <!-- Review Text -->
            <div class="mb-4">
              <label for="reviewText" class="form-label">Your Review *</label>
              <textarea class="form-control" id="reviewText" name="review_text" rows="6" 
                        placeholder="Share your thoughts about this course... (minimum 10 characters)" 
                        required minlength="10"></textarea>
              <div class="form-text">Minimum 10 characters</div>
            </div>

            <!-- Would Recommend -->
            <div class="mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="wouldRecommend" name="would_recommend" checked>
                <label class="form-check-label" for="wouldRecommend">
                  I would recommend this course to others
                </label>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-send"></i> Submit Review
              </button>
            </div>
          </form>
        </div>

        <!-- Existing Reviews -->
        <div class="existing-reviews mt-5">
          <h3 class="mb-4">Course Reviews</h3>
          <div id="reviewsList">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
.review-card {
  background: white;
  border-radius: 10px;
  padding: 40px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.course-info-header {
  display: flex;
  gap: 20px;
  padding-bottom: 30px;
  border-bottom: 2px solid #e9ecef;
  margin-bottom: 30px;
}

.course-thumbnail {
  width: 120px;
  height: 120px;
  border-radius: 10px;
  object-fit: cover;
}

.course-info-header h3 {
  margin: 0 0 10px 0;
}

/* Star Rating */
.star-rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
  gap: 5px;
  font-size: 3rem;
}

.star-rating input {
  display: none;
}

.star-rating label {
  color: #ddd;
  cursor: pointer;
  transition: color 0.2s;
}

.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input:checked ~ label {
  color: #ffc107;
}

.existing-reviews {
  background: white;
  border-radius: 10px;
  padding: 30px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.review-item {
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
}

.review-item:last-child {
  border-bottom: none;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.reviewer-name {
  font-weight: 600;
  color: var(--heading-color);
}

.review-stars {
  color: #ffc107;
}

.review-date {
  font-size: 0.85rem;
  color: var(--default-color);
}

.review-text {
  color: var(--default-color);
  line-height: 1.6;
}

.stats-summary {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  text-align: center;
}

.stats-summary h4 {
  margin: 0;
  color: var(--heading-color);
}

.stats-summary .stars {
  color: #ffc107;
  font-size: 1.5rem;
}
</style>

<script>
const courseId = '{{ course_id }}';

// Load existing reviews
document.addEventListener('DOMContentLoaded', async function() {
  await loadReviews();
});

async function loadReviews() {
  try {
    const response = await fetch(`http://localhost:8001/api/courses/${courseId}/review/list/`);
    
    if (response.ok) {
      const data = await response.json();
      displayReviews(data);
    }
  } catch (error) {
    console.error('Error loading reviews:', error);
    document.getElementById('reviewsList').innerHTML = '<p class="text-muted">Unable to load reviews</p>';
  }
}

function displayReviews(data) {
  const reviewsList = document.getElementById('reviewsList');
  
  let html = '';
  
  // Display statistics
  if (data.statistics && data.statistics.total_reviews > 0) {
    html += `
      <div class="stats-summary">
        <h4>${data.statistics.average_rating.toFixed(1)} <span class="stars">★</span></h4>
        <p class="mb-0">${data.statistics.total_reviews} review${data.statistics.total_reviews > 1 ? 's' : ''}</p>
      </div>
    `;
  }
  
  // Display reviews
  if (data.reviews && data.reviews.length > 0) {
    data.reviews.forEach(review => {
      const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
      const date = new Date(review.created_at).toLocaleDateString();
      
      html += `
        <div class="review-item">
          <div class="review-header">
            <div>
              <div class="reviewer-name">${review.student_name || 'Anonymous'}</div>
              <div class="review-stars">${stars}</div>
            </div>
            <div class="review-date">${date}</div>
          </div>
          <p class="review-text">${review.review_text || 'No comment provided'}</p>
          ${review.would_recommend ? '<span class="badge bg-success"><i class="bi bi-hand-thumbs-up"></i> Recommends</span>' : ''}
        </div>
      `;
    });
  } else {
    html += '<p class="text-muted text-center">No reviews yet. Be the first to review!</p>';
  }
  
  reviewsList.innerHTML = html;
}

// Handle form submission
document.getElementById('reviewForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const rating = document.querySelector('input[name="rating"]:checked');
  const reviewText = document.getElementById('reviewText').value;
  const wouldRecommend = document.getElementById('wouldRecommend').checked;
  
  if (!rating) {
    alert('Please select a rating');
    return;
  }
  
  if (reviewText.length < 10) {
    alert('Review must be at least 10 characters long');
    return;
  }
  
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
  
  try {
    const response = await fetch(`http://localhost:8001/api/courses/${courseId}/review/submit/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer {{ request.session.access_token }}'
      },
      body: JSON.stringify({
        rating: parseInt(rating.value),
        review_text: reviewText,
        would_recommend: wouldRecommend
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert('Review submitted successfully!');
      // Reload reviews
      await loadReviews();
      // Reset form
      this.reset();
    } else {
      alert(data.error || 'Failed to submit review');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred. Please try again.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-send"></i> Submit Review';
  }
});
</script>
{% endblock %}
