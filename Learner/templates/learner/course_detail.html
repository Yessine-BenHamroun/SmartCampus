{% extends 'learner/base.html' %} {% load static %} {% block title %}{{
course.title }} - SmartCampus{% endblock %} {% block body_class
%}course-detail-page{% endblock %} {% block content %}
<!-- Page Header -->
<section class="page-header section light-background">
  <div class="container">
    <div class="row">
      <div class="col-lg-8" data-aos="fade-up">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'index' %}">Home</a>
            </li>
            <li class="breadcrumb-item">
              <a href="{% url 'courses' %}">Courses</a>
            </li>
            <li class="breadcrumb-item active">{{ course.title }}</li>
          </ol>
        </nav>
        <h1>{{ course.title }}</h1>
        <p class="lead">
          {{
          course.short_description|default:course.description|truncatewords:30
          }}
        </p>

        <div class="course-meta-top">
          <div class="rating">
            <i class="bi bi-star-fill"></i>
            <span>{{ course.rating|default:"0.0" }}</span>
            <span class="text-muted"
              >({{ course.reviews_count|default:0 }} reviews)</span
            >
          </div>
          <div class="students">
            <i class="bi bi-people"></i>
            <span>{{ course.enrolled_count|default:0 }} students enrolled</span>
          </div>
          <div class="level">
            <i class="bi bi-bar-chart"></i>
            <span
              >{{ course.level|default:course.difficulty_level|title }}</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Course Detail Section -->
<section class="course-detail-section section">
  <div class="container">
    <div class="row">
      <!-- Main Content -->
      <div class="col-lg-8">
        <!-- Course Image -->
        <div class="course-hero-image" data-aos="fade-up">
          {% if course.thumbnail %}
          <img
            src="{{ course.thumbnail }}"
            alt="{{ course.title }}"
            class="img-fluid rounded"
          />
          {% else %}
          <img
            src="{% static 'img/education/courses-3.webp' %}"
            alt="{{ course.title }}"
            class="img-fluid rounded"
          />
          {% endif %}
        </div>

        <!-- What You'll Learn -->
        {% if course.learning_objectives %}
        <div class="course-section" data-aos="fade-up">
          <h3><i class="bi bi-check-circle"></i> What You'll Learn</h3>
          <div class="description-content">
            {{ course.learning_objectives|safe }}
          </div>
        </div>
        {% endif %}

        <!-- Course Description -->
        <div class="course-section" data-aos="fade-up">
          <h3><i class="bi bi-journal-text"></i> Course Description</h3>
          <div class="description-content">
            <p>{{ course.description }}</p>
          </div>
        </div>

        <!-- Course Curriculum -->
        <div class="course-section" data-aos="fade-up">
          <h3><i class="bi bi-list-ul"></i> Course Curriculum</h3>
          <p class="text-muted mb-3">
            {{ modules|length }} modules • Preview available for free lessons
          </p>

          <div class="curriculum-list">
            {% for module in modules %}
            <div class="curriculum-module">
              <div class="module-header">
                <h4>
                  <i class="bi bi-folder2"></i>
                  Module {{ forloop.counter }}: {{ module.title }}
                </h4>
                <span class="lesson-count"
                  >{{ module.lessons|length|default:0 }} lessons</span
                >
              </div>

              {% if module.description %}
              <p class="module-description">{{ module.description }}</p>
              {% endif %}

              <!-- Show lesson titles but lock content -->
              <div class="lessons-preview">
                {% if module.lessons %} {% for lesson in module.lessons %}
                <div
                  class="lesson-item {% if not is_enrolled and not lesson.is_free_preview %}locked{% endif %}"
                >
                  <div class="lesson-info">
                    <i
                      class="bi {% if lesson.content_type == 'video' %}bi-play-circle{% elif lesson.content_type == 'quiz' %}bi-question-circle{% else %}bi-file-text{% endif %}"
                    ></i>
                    <span class="lesson-title">{{ lesson.title }}</span>
                  </div>
                  <div class="lesson-meta">
                    {% if lesson.is_free_preview %}
                    <span class="badge bg-success">Preview</span>
                    {% elif not is_enrolled %}
                    <i class="bi bi-lock"></i>
                    {% endif %}
                    <span class="duration"
                      >{{ lesson.duration_minutes|default:0 }} min</span
                    >
                  </div>
                </div>
                {% endfor %} {% else %}
                <p class="text-muted">Lessons will be available soon</p>
                {% endif %}
              </div>
            </div>
            {% empty %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Course curriculum is being
              prepared
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Certifications Section -->
        <div class="course-section" data-aos="fade-up">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h3><i class="bi bi-trophy"></i> Course Certifications</h3>
              <p class="text-muted mb-0">
                Earn professional certificates by completing certification
                programs
              </p>
            </div>

            <!-- Debug: Always show for instructors, then we'll add the condition back -->
            {% if user.is_authenticated and user.role == 'instructor' %}
            <a
              href="{% url 'create_certification' course.id %}"
              class="btn btn-primary"
            >
              <i class="bi bi-plus-circle"></i> Add Certification
            </a>
            {% endif %}
          </div>

          {% if certifications %}
          <div class="certifications-list">
            {% for cert in certifications %}
            <div class="certification-card">
              <div class="cert-header">
                {% if cert.badge_image %}
                <img
                  src="{{ cert.badge_image }}"
                  alt="{{ cert.title }}"
                  class="cert-badge"
                />
                {% else %}
                <div class="cert-badge-placeholder">
                  <i class="bi bi-award"></i>
                </div>
                {% endif %}
                <div class="cert-info">
                  <h4>{{ cert.title }}</h4>
                  <p class="text-muted">
                    {{ cert.description|truncatewords:20 }}
                  </p>
                </div>
              </div>

              <div class="cert-meta">
                <div class="meta-item">
                  <i class="bi bi-list-check"></i>
                  <span>{{ cert.total_steps }} steps</span>
                </div>
                <div class="meta-item">
                  <i class="bi bi-bar-chart"></i>
                  <span>{{ cert.passing_score }}% passing score</span>
                </div>
                {% if cert.is_active %}
                <div class="meta-item">
                  <span class="badge bg-success">Active</span>
                </div>
                {% else %}
                <div class="meta-item">
                  <span class="badge bg-secondary">Inactive</span>
                </div>
                {% endif %}
              </div>

              <!-- Check if user has progress in this certification -->
              {% if my_progress %} {% for progress in my_progress %} {% if
              progress.certification_id == cert.id %}
              <div class="cert-progress">
                <div class="progress-info">
                  <span
                    >Progress: {{ progress.current_step }}/{{ cert.total_steps
                    }} steps</span
                  >
                  <span
                    class="badge {% if progress.status == 'completed' %}bg-success{% elif progress.status == 'in_progress' %}bg-primary{% elif progress.status == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}"
                  >
                    {{ progress.status|title }}
                  </span>
                </div>
                {% if progress.badge_earned %}
                <div class="alert alert-success mt-2">
                  <i class="bi bi-check-circle-fill"></i> Badge Earned!
                  <a href="/my-badges/" class="btn btn-sm btn-success ms-2"
                    >View Badge</a
                  >
                </div>
                {% elif progress.status == 'in_progress' %}
                <a
                  href="/certification/{{ cert.id }}/steps/"
                  class="btn btn-primary btn-sm mt-2"
                >
                  <i class="bi bi-play-circle"></i> Continue Certification
                </a>
                {% elif progress.status == 'failed' %}
                <p class="text-danger mt-2">
                  <i class="bi bi-exclamation-circle"></i> Exam attempts
                  exhausted
                </p>
                {% endif %}
              </div>
              {% endif %} {% endfor %} {% endif %}

              <!-- Show enrollment button if not enrolled in certification -->
              {% if is_enrolled and cert.is_active %} {% if not my_progress or
              not my_progress|length %}
              <button
                class="btn btn-outline-primary btn-sm mt-3 enroll-cert-btn"
                data-cert-id="{{ cert.id }}"
                onclick="enrollInCertification('{{ cert.id }}')"
              >
                <i class="bi bi-award"></i> Start Certification
              </button>
              {% else %} {% with has_progress=False %} {% for progress in
              my_progress %} {% if progress.certification_id == cert.id %} {%
              with has_progress=True %}{% endwith %} {% endif %} {% endfor %} {%
              if not has_progress %}
              <button
                class="btn btn-outline-primary btn-sm mt-3 enroll-cert-btn"
                data-cert-id="{{ cert.id }}"
                onclick="enrollInCertification('{{ cert.id }}')"
              >
                <i class="bi bi-award"></i> Start Certification
              </button>
              {% endif %} {% endwith %} {% endif %} {% elif not is_enrolled %}
              <div class="alert alert-warning mt-3">
                <i class="bi bi-lock"></i> Enroll in the course to access
                certifications
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %} {% if user.is_authenticated and user.role == 'instructor'
          %} {% if course.instructor_id == user.id or course.instructor_id ==
          user.email %}
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No certifications created yet.
            <a
              href="{% url 'create_certification' course.id %}"
              class="alert-link"
              >Create your first certification</a
            >
          </div>
          {% else %}
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No certifications available for
            this course yet.
          </div>
          {% endif %} {% else %}
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No certifications available for
            this course yet.
          </div>
          {% endif %} {% endif %}
        </div>

        <!-- Requirements -->
        {% if course.requirements %}
        <div class="course-section" data-aos="fade-up">
          <h3><i class="bi bi-clipboard-check"></i> Requirements</h3>
          <div class="description-content">{{ course.requirements|safe }}</div>
        </div>
        {% endif %}

        <!-- Instructor Info -->
        {% if course.instructor_name or course.instructor_id %}
        <div class="course-section" data-aos="fade-up">
          <h3><i class="bi bi-person"></i> Your Instructor</h3>
          <div class="instructor-card">
            {% if course.instructor_photo %}
            <img
              src="{{ course.instructor_photo }}"
              alt="{{ course.instructor_name }}"
              class="instructor-photo"
            />
            {% else %}
            <div class="instructor-photo-placeholder">
              <i class="bi bi-person-circle"></i>
            </div>
            {% endif %}
            <div class="instructor-details">
              <h4>{{ course.instructor_name|default:"Course Instructor" }}</h4>
              {% if course.instructor_bio %}
              <p class="text-muted">
                {{ course.instructor_bio|truncatewords:20 }}
              </p>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="course-sidebar" data-aos="fade-left">
          <!-- Price Card -->
          <div class="price-card">
            {% if course.price > 0 %}
            <div class="price">${{ course.price }}</div>
            {% else %}
            <div class="price free">Free</div>
            {% endif %} {% if user.role == 'instructor' %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> You are viewing this as an
              instructor. {% if course.instructor_id == user.id or
              course.instructor_id == user.email %}
              <a
                href="{% url 'edit_course' course.id %}"
                class="btn btn-sm btn-primary mt-2 w-100"
              >
                <i class="bi bi-pencil"></i> Edit This Course
              </a>
              {% endif %}
            </div>
            {% elif is_enrolled %}
            <a
              href="{% url 'my_learning' %}"
              class="btn btn-success btn-lg w-100 mb-2"
            >
              <i class="bi bi-play-circle"></i> Continue Learning
            </a>
            <p class="text-center text-muted">
              <i class="bi bi-check-circle"></i> You're enrolled!
            </p>
            {% else %}
            <button
              id="enrollBtn"
              class="btn btn-primary btn-lg w-100 mb-2"
              onclick="enrollInCourse()"
            >
              <i class="bi bi-bookmark-plus"></i> Enroll Now
            </button>
            {% endif %}
          </div>

          <!-- Course Includes -->
          <div class="includes-card">
            <h4>This course includes:</h4>
            <ul class="includes-list">
              {% if course.duration_hours %}
              <li>
                <i class="bi bi-clock"></i> {{ course.duration_hours }} hours
                on-demand content
              </li>
              {% endif %}
              <li><i class="bi bi-phone"></i> Access on mobile and desktop</li>
              <li><i class="bi bi-infinity"></i> Full lifetime access</li>
              {% if certifications %}
              <li><i class="bi bi-trophy"></i> Certificate of completion</li>
              {% endif %}
            </ul>
          </div>

          <!-- Course Info -->
          <div class="info-card">
            <h4>Course Information</h4>
            <ul class="info-list">
              {% if course.category %}
              <li>
                <strong>Category:</strong>
                <span>{{ course.category|title }}</span>
              </li>
              {% endif %} {% if course.level or course.difficulty_level %}
              <li>
                <strong>Level:</strong>
                <span
                  >{{ course.level|default:course.difficulty_level|title
                  }}</span
                >
              </li>
              {% endif %} {% if course.duration_hours %}
              <li>
                <strong>Duration:</strong>
                <span>{{ course.duration_hours }} hours</span>
              </li>
              {% endif %} {% if course.language %}
              <li>
                <strong>Language:</strong>
                <span>{{ course.language }}</span>
              </li>
              {% endif %} {% if course.updated_at %}
              <li>
                <strong>Last Updated:</strong>
                <span>{{ course.updated_at|date:"M d, Y" }}</span>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .course-meta-top {
    display: flex;
    gap: 30px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .course-meta-top > div {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .course-meta-top i {
    color: var(--accent-color);
  }

  .course-hero-image {
    margin-bottom: 40px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
  }

  .course-section {
    background: white;
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .course-section h3 {
    margin-bottom: 20px;
    font-size: 1.5rem;
    color: var(--heading-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .course-section h3 i {
    color: var(--accent-color);
  }

  .learning-objectives {
    list-style: none;
    padding: 0;
  }

  .learning-objectives li {
    padding: 10px 0;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .learning-objectives i {
    color: #28a745;
    font-size: 1.2rem;
    margin-top: 2px;
  }

  .curriculum-module {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    overflow: hidden;
  }

  .module-header {
    background: #f8f9fa;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
  }

  .module-header h4 {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .lesson-count {
    color: #6c757d;
    font-size: 0.9rem;
  }

  .module-description {
    padding: 15px 20px;
    margin: 0;
    background: #fff;
    border-bottom: 1px solid #dee2e6;
  }

  .lessons-preview {
    padding: 10px;
  }

  .lesson-item {
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 6px;
    margin-bottom: 5px;
    transition: background 0.3s;
  }

  .lesson-item:hover {
    background: #f8f9fa;
  }

  .lesson-item.locked {
    opacity: 0.7;
  }

  .lesson-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .lesson-info i {
    color: var(--accent-color);
  }

  .lesson-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #6c757d;
    font-size: 0.9rem;
  }

  .requirements-list {
    list-style: none;
    padding: 0;
  }

  .requirements-list li {
    padding: 10px 0;
    padding-left: 30px;
    position: relative;
  }

  .requirements-list li:before {
    content: "•";
    position: absolute;
    left: 10px;
    color: var(--accent-color);
    font-weight: bold;
  }

  .instructor-card {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    align-items: center;
  }

  .instructor-photo,
  .instructor-photo-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .instructor-photo-placeholder {
    background: linear-gradient(135deg, var(--accent-color), #6610f2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 3rem;
  }

  .instructor-details {
    flex: 1;
  }

  .instructor-details h4 {
    margin-bottom: 5px;
  }

  .instructor-details p {
    margin-bottom: 0;
    font-size: 0.9rem;
  }

  .course-sidebar {
    position: sticky;
    top: 100px;
  }

  .price-card,
  .includes-card,
  .info-card,
  .share-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
  }

  .price {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--heading-color);
    text-align: center;
    margin-bottom: 20px;
  }

  .price.free {
    color: #28a745;
  }

  .includes-list,
  .info-list {
    list-style: none;
    padding: 0;
  }

  .includes-list li,
  .info-list li {
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .includes-list li:last-child,
  .info-list li:last-child {
    border-bottom: none;
  }

  .includes-list i {
    color: var(--accent-color);
  }

  .info-list {
    margin-top: 15px;
  }

  .info-list li {
    display: flex;
    justify-content: space-between;
  }

  .share-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .share-buttons .btn {
    flex: 1;
  }

  @media (max-width: 991px) {
    .course-sidebar {
      position: static;
      margin-top: 30px;
    }
  }

  /* Certifications Styles */
  .certifications-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .certification-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    transition: all 0.3s ease;
  }

  .certification-card:hover {
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .cert-header {
    display: flex;
    gap: 15px;
    align-items: start;
    margin-bottom: 15px;
  }

  .cert-badge,
  .cert-badge-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .cert-badge-placeholder {
    background: linear-gradient(135deg, var(--accent-color), #6610f2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
  }

  .cert-info h4 {
    margin: 0 0 5px 0;
    font-size: 1.1rem;
    color: var(--heading-color);
  }

  .cert-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    color: #6c757d;
  }

  .meta-item i {
    color: var(--accent-color);
  }

  .cert-progress {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
  }

  .progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
  }

  .enroll-cert-btn {
    width: 100%;
  }
</style>

<script>
  const courseId = "{{ course.id }}";

  async function enrollInCourse() {
    const enrollBtn = document.getElementById("enrollBtn");
    enrollBtn.disabled = true;
    enrollBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span>Enrolling...';

    try {
      const response = await fetch(
        `http://localhost:8001/api/courses/${courseId}/enroll/`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer {{ request.session.access_token }}",
          },
        }
      );

      const data = await response.json();

      if (response.ok) {
        alert("Successfully enrolled in the course!");
        window.location.reload();
      } else if (response.status === 401 || response.status === 403) {
        alert("Please log in to enroll in this course");
        window.location.href = '{% url "login" %}?next={{ request.path }}';
      } else {
        alert(data.error || "Failed to enroll in course");
        enrollBtn.disabled = false;
        enrollBtn.innerHTML =
          '<i class="bi bi-bookmark-plus"></i> Start Learning';
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred. Please try again.");
      enrollBtn.disabled = false;
      enrollBtn.innerHTML =
        '<i class="bi bi-bookmark-plus"></i> Start Learning';
    }
  }

  async function enrollInCertification(certId) {
    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span>Enrolling...';

    try {
      const response = await fetch(
        `http://localhost:8001/api/certifications/${certId}/enroll/`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer {{ request.session.access_token }}",
          },
        }
      );

      const data = await response.json();

      if (response.ok) {
        alert(
          "Successfully enrolled in certification! You can now start completing steps."
        );
        window.location.reload();
      } else if (response.status === 401 || response.status === 403) {
        alert("Please log in to enroll in this certification");
        window.location.href = '{% url "login" %}?next={{ request.path }}';
      } else {
        alert(data.error || "Failed to enroll in certification");
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred. Please try again.");
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  }
</script>
{% endblock %}
