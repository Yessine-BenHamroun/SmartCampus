{% extends 'learner/base.html' %}
{% load static %}

{% block title %}Take Quiz - SmartCampus{% endblock %}

{% block content %}
<section class="page-header section light-background">
  <div class="container">
    <h1>{{ quiz.title }}</h1>
    <p>{{ quiz.description }}</p>
  </div>
</section>

<section class="quiz-section section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="quiz-card">
          <form id="quizForm">
            {% csrf_token %}
            <div id="questionsContainer"></div>
            <button type="submit" class="btn btn-primary">Submit Quiz</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

{{ quiz_json|json_script:"quiz-data" }}

<script>
const quizData = JSON.parse(document.getElementById('quiz-data').textContent);
const accessToken = '{{ access_token }}';

// Render quiz questions
function renderQuiz() {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = '';

    quizData.questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item mb-4';
        questionDiv.innerHTML = `
            <h5 class="question-text mb-3">${index + 1}. ${question.question_text}</h5>
            <div class="options">
                ${question.options.map((option, optionIndex) => `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_${index}" value="${optionIndex}" id="q${index}_opt${optionIndex}">
                        <label class="form-check-label" for="q${index}_opt${optionIndex}">
                            ${option}
                        </label>
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(questionDiv);
    });
}

// Submit quiz
async function submitQuiz(answers) {
    try {
        const response = await fetch(`http://localhost:8001/api/courses/quiz/${quizData.id}/submit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ answers: answers })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Quiz submitted! Score: ${result.score}/${result.total_points}`);
            window.location.href = '/my-learning/';
        } else {
            const error = await response.json();
            alert('Error submitting quiz: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error submitting quiz. Please try again.');
    }
}

// Initialize quiz
document.addEventListener('DOMContentLoaded', function() {
    renderQuiz();
});

// Handle form submission
document.getElementById('quizForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const answers = [];
    const questions = quizData.questions;

    for (let i = 0; i < questions.length; i++) {
        const selectedOption = document.querySelector(`input[name="question_${i}"]:checked`);
        if (selectedOption) {
            answers.push({
                question_index: i,
                selected_answer: parseInt(selectedOption.value)
            });
        } else {
            alert(`Please answer question ${i + 1}`);
            return;
        }
    }

    submitQuiz(answers);
});
</script>
{% endblock %}
